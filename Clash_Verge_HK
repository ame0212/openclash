/***
 * Clash Verge Rev å…¨å±€æ‰©å±•è„šæœ¬ï¼ˆæ‡’äººé…ç½®ï¼‰/ Mihomo Party è¦†å†™è„šæœ¬
 * URL: https://gist.github.com/dahaha-365/0b8beb613f8d1ee656fe1f21e1a07959
 */

/**
 * æ•´ä¸ªè„šæœ¬çš„æ€»å¼€å…³ï¼Œåœ¨Mihomo Partyä½¿ç”¨çš„è¯ï¼Œè¯·ä¿æŒä¸ºtrue
 * true = å¯ç”¨
 * false = ç¦ç”¨
 */
const enable = true;

/**
 * åˆ†æµè§„åˆ™é…ç½®ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ç­–ç•¥ç»„
 * è®¾ç½®çš„æ—¶å€™å¯éµå¾ªâ€œæœ€å°ï¼Œå¯ç”¨â€åŽŸåˆ™ï¼ŒæŠŠè‡ªå·±ä¸éœ€è¦çš„è§„åˆ™å…¨ç¦ç”¨æŽ‰ï¼Œæé«˜æ•ˆçŽ‡
 * true = å¯ç”¨
 * false = ç¦ç”¨
 */
const ruleOptions = {
  openai: true, // å›½å¤–AIå’ŒGPT
  tiktok: true, // å›½é™…ç‰ˆæŠ–éŸ³
  tracker: true, // ç½‘ç»œåˆ†æžå’Œè·Ÿè¸ªæœåŠ¡
  ads: true, // å¸¸è§çš„ç½‘ç»œå¹¿å‘Š
};

/**
 * æ–°å¢žæµè¡ŒAIåŸŸååˆ†æµè¦å‰‡
 * å¯æŒçºŒæ“´å……
 */
const popularAIDomains = [
  // OpenAI
  "DOMAIN-SUFFIX,openai.com,å›½å¤–AI",
  "DOMAIN-SUFFIX,chat.openai.com,å›½å¤–AI",
  // Google Gemini
  "DOMAIN-SUFFIX,gemini.google.com,å›½å¤–AI",
  "DOMAIN-SUFFIX,ai.google.dev,å›½å¤–AI",
  // Anthropic Claude
  "DOMAIN-SUFFIX,claude.ai,å›½å¤–AI",
  "DOMAIN-SUFFIX,anthropic.com,å›½å¤–AI",
  // Groq
  "DOMAIN-SUFFIX,groq.com,å›½å¤–AI",
  "DOMAIN-SUFFIX,groq.cloud,å›½å¤–AI",
  // Mistral AI
  "DOMAIN-SUFFIX,mistral.ai,å›½å¤–AI",
  // Meta AI / Llama
  "DOMAIN-SUFFIX,meta.ai,å›½å¤–AI",
  "DOMAIN-SUFFIX,llama.meta.com,å›½å¤–AI",
  // OpenRouter
  "DOMAIN-SUFFIX,openrouter.ai,å›½å¤–AI",
  // Poe
  "DOMAIN-SUFFIX,poe.com,å›½å¤–AI",
  // Other popular AI
  "DOMAIN-SUFFIX,pi.ai,å›½å¤–AI",
  "DOMAIN-SUFFIX,character.ai,å›½å¤–AI",
  "DOMAIN-SUFFIX,jan.ai,å›½å¤–AI"
];

/**
 * åœ°åŒºé…ç½®ï¼Œé€šè¿‡regexåŒ¹é…ä»£ç†èŠ‚ç‚¹åç§°
 * excludeHighPercentageæ˜¯æŽ’é™¤é«˜å€çŽ‡èŠ‚ç‚¹çš„å¼€å…³ï¼Œåªå¯¹åœ°åŒºåˆ†ç»„æœ‰æ•ˆ
 * å€çŽ‡å¤§äºŽregionsé‡Œçš„ratioLimitå€¼çš„ä»£ç†èŠ‚ç‚¹ä¼šè¢«æŽ’é™¤
 */
const regionOptions = {
  excludeHighPercentage: true,
  regions: [
    {
      name: "HKé¦™æ¸¯",
      regex: /æ¸¯|ðŸ‡­ðŸ‡°|hk|hongkong|hong kong/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Hong_Kong.png",
    },
    {
      name: "USç¾Žå›½",
      regex: /ç¾Ž|ðŸ‡ºðŸ‡¸|us|united state|america/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/United_States.png",
    },
    {
      name: "JPæ—¥æœ¬",
      regex: /æ—¥æœ¬|ðŸ‡¯ðŸ‡µ|jp|japan/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Japan.png",
    },
    {
      name: "KRéŸ©å›½",
      regex: /éŸ©|ðŸ‡°ðŸ‡·|kr|korea/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Korea.png",
    },
    {
      name: "SGæ–°åŠ å¡",
      regex: /æ–°åŠ å¡|ðŸ‡¸ðŸ‡¬|sg|singapore/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Singapore.png",
    },
    {
      name: "CNä¸­å›½å¤§é™†",
      regex: /ä¸­å›½|ðŸ‡¨ðŸ‡³|cn|china/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/China_Map.png",
    },
    {
      name: "TWå°æ¹¾",
      regex: /å°æ¹¾|ðŸ‡¹ðŸ‡¼|tw|taiwan|tai wan/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/China.png",
    },
    {
      name: "GBè‹±å›½",
      regex: /è‹±|ðŸ‡¬ðŸ‡§|uk|united kingdom|great britain/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/United_Kingdom.png",
    },
    {
      name: "DEå¾·å›½",
      regex: /å¾·å›½|ðŸ‡©ðŸ‡ª|de|germany/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Germany.png",
    },
    {
      name: "MYé©¬æ¥è¥¿äºš",
      regex: /é©¬æ¥|ðŸ‡²ðŸ‡¾|my|malaysia/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Malaysia.png",
    },
    {
      name: "TKåœŸè€³å…¶",
      regex: /åœŸè€³å…¶|ðŸ‡¹ðŸ‡·|tk|turkey/i,
      ratioLimit: 2,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Turkey.png",
    },
  ],
};

/**
 * DNS é…ç½®
 */
const defaultDNS = ["tls://1.12.12.12", "tls://223.5.5.5"];
const chinaDNS = ["119.29.29.29", "180.184.1.1"];
const foreignDNS = ["tls://8.8.8.8", "tls://1.1.1.1", "tls://9.9.9.9"];

const dnsConfig = {
  enable: true,
  listen: ":53",
  ipv6: true,
  "prefer-h3": true,
  "use-hosts": true,
  "use-system-hosts": true,
  "respect-rules": true,
  "enhanced-mode": "fake-ip",
  "fake-ip-range": "198.18.0.1/16",
  "fake-ip-filter": ["*", "+.lan", "+.local", "+.market.xiaomi.com"],
  "default-nameserver": [...defaultDNS],
  nameserver: [...foreignDNS],
  "proxy-server-nameserver": [...foreignDNS],
  "nameserver-policy": {
    "geosite:private": "system",
    "geosite:cn,steam@cn,category-games@cn,microsoft@cn,apple@cn": chinaDNS,
  },
};

// è§„åˆ™é›†é€šç”¨é…ç½®
const ruleProviderCommon = { type: "http", format: "yaml", interval: 86400 };
// ä»£ç†ç»„é€šç”¨é…ç½®
const groupBaseOption = {
  interval: 300,
  timeout: 3000,
  url: "http://cp.cloudflare.com/generate_204",
  lazy: true,
  "max-failed-times": 3,
  hidden: false,
};

const ruleProviders = new Map();
ruleProviders.set("applications", {
  ...ruleProviderCommon,
  behavior: "classical",
  format: "text",
  url: "https://fastly.jsdelivr.net/gh/DustinWin/ruleset_geodata@clash-ruleset/applications.list",
  path: "./ruleset/DustinWin/applications.list",
});
const rules = ["RULE-SET,applications,ä¸‹è½½è½¯ä»¶"];

// ç¨‹åºå…¥å£
function main(config) {
  const proxyCount = config?.proxies?.length ?? 0;
  const proxyProviderCount =
    typeof config?.["proxy-providers"] === "object"
      ? Object.keys(config["proxy-providers"]).length
      : 0;
  if (proxyCount === 0 && proxyProviderCount === 0) {
    throw new Error("é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ°ä»»ä½•ä»£ç†");
  }

  let regionProxyGroups = [];
  let otherProxyGroups = config.proxies.map((b) => b.name);

  config["allow-lan"] = true;
  config["bind-address"] = "*";
  config["mode"] = "rule";
  config["dns"] = dnsConfig;
  config["profile"] = { "store-selected": true, "store-fake-ip": true };
  config["unified-delay"] = true;
  config["tcp-concurrent"] = true;
  config["keep-alive-interval"] = 1800;
  config["find-process-mode"] = "strict";
  config["geodata-mode"] = true;
  config["geodata-loader"] = "memconservative";
  config["geo-auto-update"] = true;
  config["geo-update-interval"] = 24;
  config["sniffer"] = {
    enable: true,
    "force-dns-mapping": true,
    "parse-pure-ip": true,
    "override-destination": false,
    sniff: { TLS: { ports: [443, 8443] }, HTTP: { ports: [80, "8080-8880"] }, QUIC: { ports: [443, 8443] } },
    "force-domain": [],
    "skip-domain": ["Mijia Cloud", "+.oray.com"],
  };
  config["ntp"] = { enable: true, "write-to-system": false, server: "cn.ntp.org.cn" };

  if (!enable) return config;

  regionOptions.regions.forEach((region) => {
    let proxies = config.proxies
      .filter((a) => {
        const multiplier =
          /(?<=[xXâœ•âœ–â¨‰å€çŽ‡])([1-9]+(\.\d+)*|0{1}\.\d+)(?=[xXâœ•âœ–â¨‰å€çŽ‡])*/i.exec(a.name)?.[1];
        return a.name.match(region.regex) && parseFloat(multiplier || "0") <= region.ratioLimit;
      })
      .map((b) => b.name);

    if (proxies.length > 0) {
      regionProxyGroups.push({
        ...groupBaseOption,
        name: region.name,
        type: "url-test",
        tolerance: 50,
        icon: region.icon,
        proxies: proxies,
      });
    }
    otherProxyGroups = otherProxyGroups.filter((x) => !proxies.includes(x));
  });

  const proxyGroupsRegionNames = regionProxyGroups.map((v) => v.name);
  if (otherProxyGroups.length > 0) proxyGroupsRegionNames.push("å…¶ä»–èŠ‚ç‚¹");

  config["proxy-groups"] = [
    {
      ...groupBaseOption,
      name: "é»˜è®¤èŠ‚ç‚¹",
      type: "select",
      proxies: [...proxyGroupsRegionNames, "ç›´è¿ž"],
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Proxy.png",
    },
  ];

  config.proxies = config?.proxies || [];
  config.proxies.push({ name: "ç›´è¿ž", type: "direct", udp: true });

  if (ruleOptions.openai) {
    rules.push(...popularAIDomains);
    rules.push("DOMAIN-SUFFIX,grazie.ai,å›½å¤–AI","DOMAIN-SUFFIX,grazie.aws.intellij.net,å›½å¤–AI","RULE-SET,ai,å›½å¤–AI");
    ruleProviders.set("ai", {
      ...ruleProviderCommon,
      behavior: "domain",
      format: "mrs",
      url: "https://fastly.jsdelivr.net/gh/DustinWin/ruleset_geodata@clash-ruleset/ai.mrs",
      path: "./ruleset/DustinWin/ai.mrs",
    });
    config["proxy-groups"].push({
      ...groupBaseOption,
      name: "å›½å¤–AI",
      type: "select",
      proxies: ["é»˜è®¤èŠ‚ç‚¹", ...proxyGroupsRegionNames, "ç›´è¿ž"],
      url: "https://chat.openai.com/cdn-cgi/trace",
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/ChatGPT.png",
    });
  }

  if (ruleOptions.tiktok) {
    rules.push("GEOSITE,tiktok,Tiktok");
    config["proxy-groups"].push({
      ...groupBaseOption,
      name: "Tiktok",
      type: "select",
      proxies: ["é»˜è®¤èŠ‚ç‚¹", ...proxyGroupsRegionNames, "ç›´è¿ž"],
      url: "https://www.tiktok.com/",
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/TikTok.png",
    });
  }

  if (ruleOptions.tracker) {
    rules.push("GEOSITE,tracker,è·Ÿè¸ªåˆ†æž");
    config["proxy-groups"].push({
      ...groupBaseOption,
      name: "è·Ÿè¸ªåˆ†æž",
      type: "select",
      proxies: ["REJECT", "ç›´è¿ž", "é»˜è®¤èŠ‚ç‚¹"],
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Reject.png",
    });
  }

  if (ruleOptions.ads) {
    rules.push("GEOSITE,category-ads-all,å¹¿å‘Šè¿‡æ»¤");
    config["proxy-groups"].push({
      ...groupBaseOption,
      name: "å¹¿å‘Šè¿‡æ»¤",
      type: "select",
      proxies: ["REJECT", "ç›´è¿ž", "é»˜è®¤èŠ‚ç‚¹"],
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Advertising.png",
    });
  }

  rules.push("GEOSITE,private,DIRECT","GEOIP,private,DIRECT,no-resolve","GEOIP,CN,å›½å†…ç½‘ç«™,no-resolve","MATCH,å…¶ä»–å¤–ç½‘");

  config["proxy-groups"].push(
    {
      ...groupBaseOption,
      name: "ä¸‹è½½è½¯ä»¶",
      type: "select",
      proxies: ["ç›´è¿ž","REJECT","é»˜è®¤èŠ‚ç‚¹","å›½å†…ç½‘ç«™",...proxyGroupsRegionNames],
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Download.png",
    },
    {
      ...groupBaseOption,
      name: "å…¶ä»–å¤–ç½‘",
      type: "select",
      proxies: ["ç›´è¿ž","é»˜è®¤èŠ‚ç‚¹","å›½å†…ç½‘ç«™",...proxyGroupsRegionNames],
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Streaming!CN.png",
    },
    {
      ...groupBaseOption,
      name: "å›½å†…ç½‘ç«™",
      type: "select",
      proxies: ["ç›´è¿ž","é»˜è®¤èŠ‚ç‚¹",...proxyGroupsRegionNames],
      url: "http://wifi.vivo.com.cn/generate_204",
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/StreamingCN.png",
    }
  );

  config["proxy-groups"] = config["proxy-groups"].concat(regionProxyGroups);

  // === æ–°å¢ž å°æ—¥æ–°éŸ© èŠ‚ç‚¹ç»„åˆï¼ˆå« SG æ–°åŠ å¡ï¼‰ ===
  config["proxy-groups"].push({
    ...groupBaseOption,
    name: "å°æ—¥æ–°éŸ©",
    type: "url-test", // æƒ³æ‰‹å‹•é¸å°±æ”¹æˆ "select"
    tolerance: 50,
    icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/Asia.png",
    proxies: ["TWå°æ¹¾","JPæ—¥æœ¬","KRéŸ©å›½","SGæ–°åŠ å¡"],
  });

  config["rules"] = rules;
  config["rule-providers"] = Object.fromEntries(ruleProviders);

  if (otherProxyGroups.length > 0) {
    config["proxy-groups"].push({
      ...groupBaseOption,
      name: "å…¶ä»–èŠ‚ç‚¹",
      type: "select",
      proxies: otherProxyGroups,
      icon: "https://fastly.jsdelivr.net/gh/Koolson/Qure/IconSet/Color/World_Map.png",
    });
  }
  return config;
}
